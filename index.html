<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Quality Control Dashboard - Netpie</title>
    
    <!-- Use Paho MQTT library from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .header h1 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248,249,250,0.8);
            padding: 16px;
            border-radius: 15px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 8px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(220,53,69,0.5);
        }
        
        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40,167,69,0.5);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 15px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sensor-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background 0.2s ease;
        }
        
        .sensor-row:hover {
            background: rgba(102,126,234,0.05);
            border-radius: 8px;
            padding: 15px 10px;
        }
        
        .sensor-row:last-child {
            border-bottom: none;
        }
        
        .sensor-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin: 4px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }
        
        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(40,167,69,0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(220,53,69,0.4);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: #333;
            box-shadow: 0 4px 15px rgba(255,193,7,0.3);
        }
        
        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(255,193,7,0.4);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(102,126,234,0.1);
            border-radius: 25px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .pump-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(248,249,250,0.5);
            border-radius: 15px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .pump-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 0 8px rgba(220,53,69,0.3);
        }
        
        .pump-indicator.active {
            background: #28a745;
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(40,167,69,0.5);
        }
        
        .alert {
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid;
            backdrop-filter: blur(10px);
        }
        
        .alert-info {
            background: rgba(209,236,241,0.8);
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        
        .alert-success {
            background: rgba(212,237,218,0.8);
            color: #155724;
            border-left-color: #28a745;
        }
        
        .alert-danger {
            background: rgba(248,215,218,0.8);
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .chart-container {
            grid-column: 1 / -1;
            height: 400px;
            margin-top: 20px;
        }
        
        .log {
            background: rgba(248,249,250,0.8);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 15px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-error { color: #dc3545; font-weight: 500; }
        .log-success { color: #28a745; font-weight: 500; }
        .log-info { color: #667eea; font-weight: 500; }
        .log-warning { color: #ffc107; font-weight: 500; }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .connection-status.connected {
            background: rgba(40,167,69,0.1);
            color: #28a745;
            border: 1px solid rgba(40,167,69,0.2);
        }
        
        .connection-status.disconnected {
            background: rgba(220,53,69,0.1);
            color: #dc3545;
            border: 1px solid rgba(220,53,69,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåä Water Quality Control Dashboard</h1>
            <p>Netpie MQTT Connection Dashboard</p>
        </div>

        <div class="status">
            <div style="display: flex; align-items: center;">
                <div class="status-indicator" id="statusDot"></div>
                <span class="connection-status disconnected" id="statusText">Disconnected</span>
            </div>
            <div id="lastUpdate">Last Update: Never</div>
        </div>

        <div class="alert alert-info">
            <strong>üîß Netpie Connection:</strong> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ Paho MQTT ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Netpie ‡∏ö‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï 8084
        </div>

        <!-- Connection Settings -->
        <div class="card">
            <h3>üîó Connection Settings</h3>
            <div class="input-group">
                <input type="text" id="brokerHost" placeholder="Broker Host" value="broker.netpie.io">
            </div>
            <div class="input-group">
                <input type="number" id="brokerPort" placeholder="Port" value="8084">
            </div>
            <div class="input-group">
                <input type="text" id="clientId" placeholder="Client ID" value="cb8398bb-dc16-4e27-b10c-5ef5478f00f9">
            </div>
            <div class="input-group">
                <input type="text" id="username" placeholder="Username" value="7sTHo827JdGqSpHXbXN2mUqQeVk56BjD">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Password" value="SnNypnNRyQ9LKXiWLtnJ6LLP99NwGiXj">
            </div>
            <button class="btn" onclick="connectMqtt()">üîå Connect</button>
            <button class="btn btn-danger" onclick="disconnectMqtt()">‚ùå Disconnect</button>
            <button class="btn btn-warning" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="grid">
            <!-- Sensor Data -->
            <div class="card">
                <h3>üìä Sensor Data</h3>
                <div class="sensor-row">
                    <span>EC Value:</span>
                    <span class="sensor-value" id="ecValue">-- mS/cm</span>
                </div>
                <div class="sensor-row">
                    <span>pH Value:</span>
                    <span class="sensor-value" id="phValue">-- pH</span>
                </div>
                <div class="sensor-row">
                    <span>Temperature:</span>
                    <span class="sensor-value" id="temperature">-- ¬∞C</span>
                </div>
                <div class="sensor-row">
                    <span>EC Voltage:</span>
                    <span class="sensor-value" id="ecVoltage">-- V</span>
                </div>
                <div class="sensor-row">
                    <span>pH Voltage:</span>
                    <span class="sensor-value" id="phVoltage">-- V</span>
                </div>
            </div>

            <!-- Pump Controls -->
            <div class="card">
                <h3>‚öôÔ∏è Pump Control</h3>
                <div class="pump-controls">
                    <span>Pump A (Acid):</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpA"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpA_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpA_off')">OFF</button>
                    </div>
                </div>
                <div class="pump-controls">
                    <span>Pump B (Base):</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpB"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpB_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpB_off')">OFF</button>
                    </div>
                </div>
                <div class="pump-controls">
                    <span>Main Pump:</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpMain"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpMain_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpMain_off')">OFF</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="toggleMixing()" id="mixingBtn">üîÑ Start Mixing</button>
                </div>
            </div>

            <!-- Settings -->
            <div class="card">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="input-group">
                    <input type="number" id="ecTarget" placeholder="EC Target (mS/cm)" step="0.1" min="0" max="5">
                    <button class="btn" onclick="setECTarget()">Set EC</button>
                </div>
                <div class="input-group">
                    <input type="number" id="volumeTarget" placeholder="Volume (L)" step="1" min="1" max="1000">
                    <button class="btn" onclick="setVolume()">Set Volume</button>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-warning" onclick="sendCommand('start_ec_calibration')">üîß Calibrate EC</button>
                    <button class="btn btn-warning" onclick="sendCommand('start_ph_calibration')">üîß Calibrate pH</button>
                </div>
            </div>

            <!-- Status -->
            <div class="card">
                <h3>üîß System Status</h3>
                <div class="sensor-row">
                    <span>ADS1115:</span>
                    <span class="sensor-value" id="adsStatus">--</span>
                </div>
                <div class="sensor-row">
                    <span>WiFi RSSI:</span>
                    <span class="sensor-value" id="wifiRssi">-- dBm</span>
                </div>
                <div class="sensor-row">
                    <span>Mixing Status:</span>
                    <span class="sensor-value" id="mixingStatus">OFF</span>
                </div>
                <div class="sensor-row">
                    <span>EC Target:</span>
                    <span class="sensor-value" id="currentECTarget">-- mS/cm</span>
                </div>
                <div class="sensor-row">
                    <span>System Uptime:</span>
                    <span class="sensor-value" id="systemUptime">--</span>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card">
            <h3>üìà Real-time Data Chart</h3>
            <div class="chart-container">
                <canvas id="dataChart"></canvas>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="card">
            <h3>üîç Debug Log</h3>
            <div class="log" id="debugLog"></div>
        </div>
    </div>

    <script>
        let client = null;
        let isConnected = false;
        let chart = null;
        let isMixing = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'EC Value (mS/cm)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.1)',
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }, {
                        label: 'pH Value',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40,167,69,0.1)',
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }, {
                        label: 'Temperature (¬∞C)',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220,53,69,0.1)',
                        tension: 0.4,
                        yAxisID: 'y2',
                        pointBackgroundColor: '#dc3545',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'EC (mS/cm)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'pH'
                            },
                            grid: { drawOnChartArea: false },
                            min: 0,
                            max: 14
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            min: 0,
                            max: 50
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // Enhanced logging with colors
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            entry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${icon} ${message}`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
            log('Log cleared', 'info');
        }

        // MQTT Connection using Paho
        function connectMqtt() {
            const host = document.getElementById('brokerHost').value;
            const port = parseInt(document.getElementById('brokerPort').value);
            const clientId = document.getElementById('clientId').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!host || !port || !clientId || !username || !password) {
                log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Netpie...', 'info');
            updateStatus(false, 'Connecting...');

            try {
                // Create unique client ID
                const uniqueClientId = clientId + '_web_' + Math.random().toString(36).substr(2, 9);
                
                // Create MQTT client
                client = new Paho.MQTT.Client(host, port, uniqueClientId);

                // Set callback handlers
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;

                // Connection options
                const connectOptions = {
                    userName: username,
                    password: password,
                    timeout: 10,
                    keepAliveInterval: 30,
                    cleanSession: true,
                    useSSL: false,
                    onSuccess: onConnect,
                    onFailure: onConnectFailure
                };

                // Connect
                client.connect(connectOptions);
                log(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ Client ID: ${uniqueClientId}`, 'info');

            } catch (error) {
                log(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${error.message}`, 'error');
                updateStatus(false, 'Connection failed');
            }
        }

        function onConnect() {
            log('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Netpie ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ', 'success');
            isConnected = true;
            reconnectAttempts = 0;
            updateStatus(true, 'Connected to Netpie');
            
            // Subscribe to topics
            const clientId = document.getElementById('clientId').value;
            const topics = [
                `@msg/${clientId}/data`,
                `@msg/${clientId}/status`
            ];
            
            topics.forEach(topic => {
                try {
                    client.subscribe(topic);
                    log(`‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å: ${topic}`, 'success');
                } catch (error) {
                    log(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ${topic}: ${error.message}`, 'error');
                }
            });
        }

        function onConnectFailure(error) {
            log(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.errorMessage}`, 'error');
            updateStatus(false, 'Connection failed');
            
            // Auto reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                log(`‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${reconnectAttempts}/${maxReconnectAttempts} ‡πÉ‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...`, 'warning');
                setTimeout(connectMqtt, 5000);
            } else {
                log('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', 'error');
            }
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                log(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢: ${responseObject.errorMessage}`, 'error');
            }
            isConnected = false;
            updateStatus(false, 'Connection lost');
            
            // Auto reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                log(`‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${reconnectAttempts}/${maxReconnectAttempts}...`, 'warning');
                setTimeout(connectMqtt, 3000);
            }
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            
            log(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å ${topic}: ${payload}`, 'info');
            handleMessage(topic, payload);
        }

        function disconnectMqtt() {
            if (client && isConnected) {
                client.disconnect();
                isConnected = false;
                updateStatus(false, 'Disconnected');
                log('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'info');
            }
        }

        function updateStatus(connected, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                text.className = 'connection-status connected';
                text.textContent = message || 'Connected';
            } else {
                dot.classList.remove('connected');
                text.className = 'connection-status disconnected';
                text.textContent = message || 'Disconnected';
            }
        }

        function handleMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                
                if (topic.includes('/data')) {
                    updateSensorData(data);
                } else if (topic.includes('/status')) {
                    updateSystemStatus(data);
                }
                
                document.getElementById('lastUpdate').textContent = 
                    'Last Update: ' + new Date().toLocaleString('th-TH');
                    
            } catch (error) {
                log(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON: ${error.message}`, 'error');
                log(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö: ${message}`, 'warning');
            }
        }

        function updateSensorData(data) {
            // Update sensor displays
            const updates = [
                { id: 'ecValue', value: data.ec_value, unit: ' mS/cm', decimals: 2 },
                { id: 'phValue', value: data.ph_value, unit: ' pH', decimals: 2 },
                { id: 'temperature', value: data.temperature, unit: ' ¬∞C', decimals: 1 },
                { id: 'ecVoltage', value: data.ec_voltage, unit: ' V', decimals: 2 },
                { id: 'phVoltage', value: data.ph_voltage, unit: ' V', decimals: 2 }
            ];

            updates.forEach(update => {
                const element = document.getElementById(update.id);
                if (element && update.value !== undefined && update.value !== null) {
                    element.textContent = parseFloat(update.value).toFixed(update.decimals) + update.unit;
                }
            });

            // Update system status
            document.getElementById('adsStatus').textContent = data.ads_connected ? 'Connected' : 'Disconnected';
            document.getElementById('wifiRssi').textContent = (data.wifi_rssi || 0) + ' dBm';
            
            // Update chart
            if (chart && data.ec_value !== undefined && data.ph_value !== undefined) {
                const now = new Date().toLocaleTimeString('th-TH');
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push(data.ec_value || 0);
                chart.data.datasets[1].data.push(data.ph_value || 0);
                chart.data.datasets[2].data.push(data.temperature || 0);
                
                // Keep only last 20 data points
                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                    chart.data.datasets[2].data.shift();
                }
                
                chart.update('none'); // No animation for real-time updates
            }
        }

        function updateSystemStatus(data) {
            updatePumpIndicator('pumpA', data.pump_a);
            updatePumpIndicator('pumpB', data.pump_b);
            updatePumpIndicator('pumpMain', data.pump_main);
            
            document.getElementById('mixingStatus').textContent = data.mixing ? 'ON' : 'OFF';
            document.getElementById('currentECTarget').textContent = (data.ec_target || 0).toFixed(1) + ' mS/cm';
            
            if (data.uptime) {
                document.getElementById('systemUptime').textContent = formatUptime(data.uptime);
            }
            
            // Update mixing button
            isMixing = data.mixing;
            const mixingBtn = document.getElementById('mixingBtn');
            mixingBtn.textContent = isMixing ? '‚èπÔ∏è Stop Mixing' : 'üîÑ Start Mixing';
            mixingBtn.className = isMixing ? 'btn btn-danger' : 'btn btn-warning';
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}d ${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        function updatePumpIndicator(pumpId, isActive) {
            const indicator = document.getElementById(pumpId);
            if (indicator) {
                if (isActive) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            }
        }

        function sendCommand(command, value = null) {
            if (!client || !isConnected) {
                log('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ', 'error');
                return;
            }

            const clientId = document.getElementById('clientId').value;
            const topic = `@msg/${clientId}/control`;
            
            const message = { command: command };
            if (value !== null) {
                message.value = value;
            }

            const messageStr = JSON.stringify(message);
            
            try {
                const mqttMessage = new Paho.MQTT.Message(messageStr);
                mqttMessage.destinationName = topic;
                client.send(mqttMessage);
                log(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${messageStr}`, 'success');
            } catch (error) {
                log(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
            }
        }

        function toggleMixing() {
            const command = isMixing ? 'stop_mixing' : 'start_mixing';
            sendCommand(command);
        }

        function setECTarget() {
            const value = parseFloat(document.getElementById('ecTarget').value);
            if (!isNaN(value) && value >= 0 && value <= 5) {
                sendCommand('set_ec_target', value);
                log(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EC Target: ${value} mS/cm`, 'info');
            } else {
                log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ EC ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-5 mS/cm', 'error');
            }
        }

        function setVolume() {
            const value = parseInt(document.getElementById('volumeTarget').value);
            if (!isNaN(value) && value >= 1 && value <= 1000) {
                sendCommand('set_volume', value);
                log(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥: ${value} ‡∏•‡∏¥‡∏ï‡∏£`, 'info');
            } else {
                log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-1000 ‡∏•‡∏¥‡∏ï‡∏£', 'error');
            }
        }

        // Simulate data for testing (remove this in production)
        function simulateData() {
            if (!isConnected) return;
            
            const testData = {
                ec_value: (Math.random() * 2 + 1).toFixed(2),
                ph_value: (Math.random() * 2 + 6).toFixed(2),
                temperature: (Math.random() * 5 + 25).toFixed(1),
                ec_voltage: (Math.random() * 0.5 + 2.5).toFixed(2),
                ph_voltage: (Math.random() * 0.5 + 2.5).toFixed(2),
                ads_connected: Math.random() > 0.2,
                wifi_rssi: Math.floor(Math.random() * 30 - 80)
            };
            
            updateSensorData(testData);
        }

        // Auto-connect and periodic updates
        document.addEventListener('DOMContentLoaded', function() {
            log('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Water Quality Control Dashboard', 'info');
            initChart();
            
            // Auto-connect after 2 seconds
            setTimeout(() => {
                log('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...', 'info');
                connectMqtt();
            }, 2000);
            
            // Simulate data every 5 seconds for testing (remove in production)
            setInterval(simulateData, 5000);
            
            // Keep connection alive
            setInterval(() => {
                if (isConnected && client) {
                    // Send ping to keep connection alive
                    try {
                        const pingMessage = new Paho.MQTT.Message(JSON.stringify({ping: true}));
                        const clientId = document.getElementById('clientId').value;
                        pingMessage.destinationName = `@msg/${clientId}/ping`;
                        client.send(pingMessage);
                    } catch (error) {
                        // Ignore ping errors
                    }
                }
            }, 30000);
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && !isConnected) {
                log('‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• - ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà', 'info');
                setTimeout(connectMqtt, 1000);
            }
        });

        // Handle window beforeunload
        window.addEventListener('beforeunload', function() {
            if (client && isConnected) {
                client.disconnect();
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 'Enter':
                        event.preventDefault();
                        if (!isConnected) {
                            connectMqtt();
                        }
                        break;
                    case 'l':
                        event.preventDefault();
                        clearLog();
                        break;
                }
            }
        });
    </script>
</body>
</html>
