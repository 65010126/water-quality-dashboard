<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Quality Control Dashboard - Netpie</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .header h1 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248,249,250,0.8);
            padding: 16px;
            border-radius: 15px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 8px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(220,53,69,0.5);
        }
        
        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40,167,69,0.5);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 15px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sensor-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .sensor-row:last-child {
            border-bottom: none;
        }
        
        .sensor-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin: 4px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success { background: linear-gradient(45deg, #28a745, #20c997); box-shadow: 0 4px 15px rgba(40,167,69,0.3); }
        .btn-success:hover { box-shadow: 0 6px 20px rgba(40,167,69,0.4); }
        .btn-danger { background: linear-gradient(45deg, #dc3545, #fd7e14); box-shadow: 0 4px 15px rgba(220,53,69,0.3); }
        .btn-danger:hover { box-shadow: 0 6px 20px rgba(220,53,69,0.4); }
        .btn-warning { background: linear-gradient(45deg, #ffc107, #fd7e14); color: #333; box-shadow: 0 4px 15px rgba(255,193,7,0.3); }
        .btn-warning:hover { box-shadow: 0 6px 20px rgba(255,193,7,0.4); }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(102,126,234,0.1);
            border-radius: 25px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .pump-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(248,249,250,0.5);
            border-radius: 15px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .pump-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 0 8px rgba(220,53,69,0.3);
        }
        
        .pump-indicator.active {
            background: #28a745;
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(40,167,69,0.5);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .log {
            background: rgba(248,249,250,0.8);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 15px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }
        
        .log-entry { margin-bottom: 5px; padding: 2px 0; }
        .log-error { color: #dc3545; font-weight: 500; }
        .log-success { color: #28a745; font-weight: 500; }
        .log-info { color: #667eea; font-weight: 500; }
        .log-warning { color: #ffc107; font-weight: 500; }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .connection-status.connected { background: rgba(40,167,69,0.1); color: #28a745; border: 1px solid rgba(40,167,69,0.2); }
        .connection-status.disconnected { background: rgba(220,53,69,0.1); color: #dc3545; border: 1px solid rgba(220,53,69,0.2); }
        .connection-status.connecting { background: rgba(255,193,7,0.1); color: #ffc107; border: 1px solid rgba(255,193,7,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåä Water Quality Control Dashboard</h1>
            <p>Real-time Monitoring & Control via Netpie</p>
        </div>

        <div class="status">
            <div style="display: flex; align-items: center;">
                <div class="status-indicator" id="statusDot"></div>
                <span class="connection-status disconnected" id="statusText">Disconnected</span>
            </div>
            <div id="lastUpdate">Last Update: Never</div>
        </div>

        <div class="card">
            <h3>üîó Connection Settings</h3>
            <div class="input-group">
                <input type="text" id="deviceKey" placeholder="Device Key" value="cb8398bb-dc16-4e27-b10c-5ef5478f00f9">
            </div>
            <div class="input-group">
                <input type="text" id="deviceToken" placeholder="Device Token" value="7sTHo827JdGqSpHXbXN2mUqQeVk56BjD">
            </div>
            <div class="input-group">
                <input type="password" id="deviceSecret" placeholder="Device Secret" value="SnNypnNRyQ9LKXiWLtnJ6LLP99NwGiXj">
            </div>
            <button class="btn" onclick="connectNetpie()" id="connectBtn">üîå Connect</button>
            <button class="btn btn-danger" onclick="disconnectNetpie()" id="disconnectBtn" disabled>‚ùå Disconnect</button>
            <button class="btn btn-warning" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üìä Sensor Data</h3>
                <div class="sensor-row"><span>EC Value:</span><span class="sensor-value" id="ecValue">-- mS/cm</span></div>
                <div class="sensor-row"><span>pH Value:</span><span class="sensor-value" id="phValue">-- pH</span></div>
                <div class="sensor-row"><span>Temperature:</span><span class="sensor-value" id="temperature">-- ¬∞C</span></div>
                <div class="sensor-row"><span>EC Voltage:</span><span class="sensor-value" id="ecVoltage">-- V</span></div>
                <div class="sensor-row"><span>pH Voltage:</span><span class="sensor-value" id="phVoltage">-- V</span></div>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è Pump Control</h3>
                <div class="pump-controls">
                    <span>Pump A (Acid):</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpA"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpA_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpA_off')">OFF</button>
                    </div>
                </div>
                <div class="pump-controls">
                    <span>Pump B (Base):</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpB"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpB_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpB_off')">OFF</button>
                    </div>
                </div>
                <div class="pump-controls">
                    <span>Main Pump:</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpMain"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpMain_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpMain_off')">OFF</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="toggleMixing()" id="mixingBtn">üîÑ Start Mixing</button>
                </div>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="input-group">
                    <input type="number" id="ecTarget" placeholder="EC Target (mS/cm)" step="0.1" min="0" max="5">
                    <button class="btn" onclick="setECTarget()">Set EC</button>
                </div>
                <div class="input-group">
                    <input type="number" id="volumeTarget" placeholder="Volume (L)" step="1" min="1" max="1000">
                    <button class="btn" onclick="setVolume()">Set Volume</button>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-warning" onclick="sendCommand('start_ec_calibration')">üîß Calibrate EC</button>
                    <button class="btn btn-warning" onclick="sendCommand('start_ph_calibration')">üîß Calibrate pH</button>
                </div>
            </div>

            <div class="card">
                <h3>üîß System Status</h3>
                <div class="sensor-row"><span>Connection:</span><span class="sensor-value" id="connectionStatus">Disconnected</span></div>
                <div class="sensor-row"><span>ADS1115:</span><span class="sensor-value" id="adsStatus">--</span></div>
                <div class="sensor-row"><span>WiFi RSSI:</span><span class="sensor-value" id="wifiRssi">-- dBm</span></div>
                <div class="sensor-row"><span>Mixing Status:</span><span class="sensor-value" id="mixingStatus">OFF</span></div>
                <div class="sensor-row"><span>EC Target:</span><span class="sensor-value" id="currentECTarget">-- mS/cm</span></div>
                <div class="sensor-row"><span>Messages Sent:</span><span class="sensor-value" id="messagesSent">0</span></div>
                <div class="sensor-row"><span>Messages Received:</span><span class="sensor-value" id="messagesReceived">0</span></div>
            </div>
        </div>

        <div class="card">
            <h3>üìà Real-time Data Chart</h3>
            <div class="chart-container">
                <canvas id="dataChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>üîç Debug Log</h3>
            <div class="log" id="debugLog"></div>
        </div>
    </div>

    <script>
        let client = null;
        let chart = null;
        let isMixing = false;
        let messagesSent = 0;
        let messagesReceived = 0;
    
        // --- Chart and Logging functions ---
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'EC Value (mS/cm)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'pH Value',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40,167,69,0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }, {
                        label: 'Temperature (¬∞C)',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220,53,69,0.1)',
                        tension: 0.4,
                        yAxisID: 'y2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'EC (mS/cm)' } },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: 'pH' }, grid: { drawOnChartArea: false }, min: 0, max: 14 },
                        y2: { type: 'linear', display: false, min: 0, max: 50 }
                    }
                }
            });
        }
    
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            entry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${icon} ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            if (logDiv.children.length > 100) logDiv.removeChild(logDiv.firstChild);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
            log('Log cleared', 'info');
        }
    
        // --- Connection Logic using MQTT.js ---
        function connectNetpie() {
            const deviceKey = document.getElementById('deviceKey').value.trim();
            const deviceToken = document.getElementById('deviceToken').value.trim();
            const deviceSecret = document.getElementById('deviceSecret').value.trim();
    
            if (!deviceKey || !deviceToken || !deviceSecret) {
                log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Device Key, Token ‡πÅ‡∏•‡∏∞ Secret ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
    
            const brokerUrl = 'wss://broker.netpie.io:8084/mqtt';
            const options = {
                clientId: deviceKey,
                username: deviceToken,
                password: deviceSecret,
                clean: true,
                connectTimeout: 10000 // 10 seconds
            };
    
            log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Netpie ‡∏ó‡∏µ‡πà ${brokerUrl}...`, 'info');
            updateStatus('connecting', 'Connecting...');
            document.getElementById('connectBtn').disabled = true;
    
            client = mqtt.connect(brokerUrl, options);
    
            client.on('connect', function () {
                log('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Netpie ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ', 'success');
                updateStatus('connected', 'Connected');
                document.getElementById('disconnectBtn').disabled = false;
                
                const subscribeTopic = '@shadow/data/updated';
                client.subscribe(subscribeTopic, function (err) {
                    if (!err) {
                        log(`‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å topic: ${subscribeTopic}`, 'success');
                    } else {
                        log(`Subscribe ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err}`, 'error');
                    }
                });
            });
    
            client.on('message', function (topic, payload) {
                messagesReceived++;
                updateMessageCount();
                const message = payload.toString();
                log(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å [${topic}]: ${message}`, 'info');
                try {
                    const data = JSON.parse(message);
                    handleDataMessage(data.data || data); 
                } catch (e) {
                    log(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON: ${e.message}`, 'error');
                }
            });
    
            client.on('error', function (err) {
                log(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${err.message}`, 'error');
                client.end();
            });
    
            client.on('close', function () {
                if (document.getElementById('connectBtn').disabled) {
                     log('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î', 'warning');
                }
                updateStatus('disconnected', 'Disconnected');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                client = null;
            });
        }
    
        function disconnectNetpie() {
            if (client) {
                log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'info');
                client.end();
            }
        }
    
        // --- Command Sending Logic ---
        function sendCommand(command) {
            if (!client || !client.connected) {
                log('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ', 'error');
                return;
            }
            
            const publishTopic = '@msg/command'; 
            const payload = JSON.stringify({ command: command, timestamp: new Date().toISOString() });
    
            client.publish(publishTopic, payload, function(err) {
                if (err) {
                    log(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "${command}" ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err}`, 'error');
                } else {
                    messagesSent++;
                    updateMessageCount();
                    log(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: "${command}" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á topic [${publishTopic}]`, 'success');
                }
            });
        }
    
        function setECTarget() {
            const target = document.getElementById('ecTarget').value;
            if (target) sendCommand(`set_ec_target:${target}`);
        }
    
        function setVolume() {
            const volume = document.getElementById('volumeTarget').value;
            if (volume) sendCommand(`set_volume:${volume}`);
        }
        
        function toggleMixing() {
            isMixing = !isMixing;
            sendCommand(isMixing ? 'start_mixing' : 'stop_mixing');
            document.getElementById('mixingBtn').textContent = isMixing ? 'üîÑ Stop Mixing' : 'üîÑ Start Mixing';
        }
    
        // --- UI Update Functions ---
        function updateStatus(status, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const connectionStatus = document.getElementById('connectionStatus');
            dot.className = 'status-indicator';
            text.className = 'connection-status';
            
            switch(status) {
                case 'connected':
                    dot.classList.add('connected');
                    text.classList.add('connected');
                    text.textContent = message || 'Connected';
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.style.color = '#28a745';
                    break;
                case 'connecting':
                    text.classList.add('connecting');
                    text.textContent = message || 'Connecting...';
                    connectionStatus.textContent = 'Connecting...';
                    connectionStatus.style.color = '#ffc107';
                    break;
                default:
                    text.classList.add('disconnected');
                    text.textContent = message || 'Disconnected';
                    connectionStatus.textContent = 'Disconnected';
                    connectionStatus.style.color = '#dc3545';
            }
        }
    
        function updateMessageCount() {
            document.getElementById('messagesSent').textContent = messagesSent;
            document.getElementById('messagesReceived').textContent = messagesReceived;
        }
    
        function handleDataMessage(data) {
            if (!data) return;
            log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${JSON.stringify(data)}`, 'info');
            updateSensorData(data);
            updateSystemStatus(data);
            document.getElementById('lastUpdate').textContent = 'Last Update: ' + new Date().toLocaleString('th-TH');
        }
    
        function updateSensorData(data) {
            const updates = [
                { id: 'ecValue', value: data.ec_value, unit: ' mS/cm', decimals: 2 },
                { id: 'phValue', value: data.ph_value, unit: ' pH', decimals: 2 },
                { id: 'temperature', value: data.temperature, unit: ' ¬∞C', decimals: 1 },
                { id: 'ecVoltage', value: data.ec_voltage, unit: ' V', decimals: 2 },
                { id: 'phVoltage', value: data.ph_voltage, unit: ' V', decimals: 2 }
            ];
            updates.forEach(update => {
                const el = document.getElementById(update.id);
                if (el && update.value !== undefined) {
                    el.textContent = parseFloat(update.value).toFixed(update.decimals) + update.unit;
                }
            });
            
            if (chart && data.ec_value !== undefined && data.ph_value !== undefined) {
                 const timeLabel = new Date().toLocaleTimeString('th-TH');
                 chart.data.labels.push(timeLabel);
                 chart.data.datasets[0].data.push(data.ec_value);
                 chart.data.datasets[1].data.push(data.ph_value);
                 chart.data.datasets[2].data.push(data.temperature);
                 
                 if (chart.data.labels.length > 30) {
                     chart.data.labels.shift();
                     chart.data.datasets.forEach(dataset => dataset.data.shift());
                 }
                 chart.update();
            }
        }
    
        function updateSystemStatus(data) {
            if (data.ads_connected !== undefined) document.getElementById('adsStatus').textContent = data.ads_connected ? 'Connected' : 'Disconnected';
            if (data.wifi_rssi !== undefined) document.getElementById('wifiRssi').textContent = data.wifi_rssi + ' dBm';
            if (data.mixing_status !== undefined) {
                isMixing = data.mixing_status;
                document.getElementById('mixingStatus').textContent = isMixing ? 'ON' : 'OFF';
                document.getElementById('mixingBtn').textContent = isMixing ? 'üîÑ Stop Mixing' : 'üîÑ Start Mixing';
            }
            if (data.ec_target !== undefined) document.getElementById('currentECTarget').textContent = data.ec_target + ' mS/cm';
            if (data.pump_a_status !== undefined) document.getElementById('pumpA').classList.toggle('active', data.pump_a_status);
            if (data.pump_b_status !== undefined) document.getElementById('pumpB').classList.toggle('active', data.pump_b_status);
            if (data.pump_main_status !== undefined) document.getElementById('pumpMain').classList.toggle('active', data.pump_main_status);
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            log('Dashboard ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Netpie', 'info');
        });
    </script>
</body>
</html>
