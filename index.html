<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Water Control Dashboard</title>
    
    <!-- Use different MQTT library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #28a745;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            margin-bottom: 16px;
            color: #333;
            font-size: 1.2em;
        }
        
        .sensor-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .sensor-row:last-child {
            border-bottom: none;
        }
        
        .sensor-value {
            font-weight: bold;
            color: #007bff;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .pump-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .pump-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 8px;
        }
        
        .pump-indicator.active {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .chart-container {
            grid-column: 1 / -1;
            height: 400px;
            margin-top: 20px;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 16px;
        }
        
        .log-entry {
            margin-bottom: 4px;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-success {
            color: #28a745;
        }
        
        .log-info {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåä Water Quality Control Dashboard</h1>
            <p>Simple MQTT Connection - Alternative Method</p>
        </div>

        <div class="status">
            <div style="display: flex; align-items: center;">
                <div class="status-indicator" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div id="lastUpdate">Last Update: Never</div>
        </div>

        <div class="alert alert-info">
            <strong>üìå Alternative Connection:</strong> This uses a different MQTT library and simplified connection method
        </div>

        <!-- Connection Settings -->
        <div class="card">
            <h3>üîó Connection Settings</h3>
            <div class="input-group">
                <input type="text" id="brokerUrl" placeholder="Broker URL" value="wss://broker.netpie.io:8884/mqtt">
            </div>
            <div class="input-group">
                <input type="text" id="clientId" placeholder="Client ID" value="cb8398bb-dc16-4e27-b10c-5ef5478f00f9">
            </div>
            <div class="input-group">
                <input type="text" id="username" placeholder="Username" value="7sTHo827JdGqSpHXbXN2mUqQeVk56BjD">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Password" value="SnNypnNRyQ9LKXiWLtnJ6LLP99NwGiXj">
            </div>
            <button class="btn" onclick="connect()">Connect</button>
            <button class="btn btn-danger" onclick="disconnect()">Disconnect</button>
            <button class="btn btn-warning" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="grid">
            <!-- Sensor Data -->
            <div class="card">
                <h3>üìä Sensor Data</h3>
                <div class="sensor-row">
                    <span>EC Value:</span>
                    <span class="sensor-value" id="ecValue">-- mS/cm</span>
                </div>
                <div class="sensor-row">
                    <span>pH Value:</span>
                    <span class="sensor-value" id="phValue">-- pH</span>
                </div>
                <div class="sensor-row">
                    <span>Temperature:</span>
                    <span class="sensor-value" id="temperature">-- ¬∞C</span>
                </div>
                <div class="sensor-row">
                    <span>EC Voltage:</span>
                    <span class="sensor-value" id="ecVoltage">-- V</span>
                </div>
                <div class="sensor-row">
                    <span>pH Voltage:</span>
                    <span class="sensor-value" id="phVoltage">-- V</span>
                </div>
            </div>

            <!-- Pump Controls -->
            <div class="card">
                <h3>‚öôÔ∏è Pump Control</h3>
                <div class="pump-controls">
                    <span>Pump A (Acid):</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpA"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpA_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpA_off')">OFF</button>
                    </div>
                </div>
                <div class="pump-controls">
                    <span>Pump B (Base):</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpB"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpB_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpB_off')">OFF</button>
                    </div>
                </div>
                <div class="pump-controls">
                    <span>Main Pump:</span>
                    <div style="display: flex; align-items: center;">
                        <div class="pump-indicator" id="pumpMain"></div>
                        <button class="btn btn-success" onclick="sendCommand('pumpMain_on')">ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('pumpMain_off')">OFF</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <button class="btn btn-warning" onclick="sendCommand('start_mixing')" id="mixingBtn">Start Mixing</button>
                </div>
            </div>

            <!-- Settings -->
            <div class="card">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="input-group">
                    <input type="number" id="ecTarget" placeholder="EC Target" step="0.1">
                    <button class="btn" onclick="setECTarget()">Set EC</button>
                </div>
                <div class="input-group">
                    <input type="number" id="volumeTarget" placeholder="Volume" step="1">
                    <button class="btn" onclick="setVolume()">Set Volume</button>
                </div>
                <div style="margin-top: 16px;">
                    <button class="btn btn-warning" onclick="sendCommand('start_ec_calibration')">Calibrate EC</button>
                    <button class="btn btn-warning" onclick="sendCommand('start_ph_calibration')">Calibrate pH</button>
                </div>
            </div>

            <!-- Status -->
            <div class="card">
                <h3>üîß System Status</h3>
                <div class="sensor-row">
                    <span>ADS1115:</span>
                    <span class="sensor-value" id="adsStatus">--</span>
                </div>
                <div class="sensor-row">
                    <span>WiFi RSSI:</span>
                    <span class="sensor-value" id="wifiRssi">-- dBm</span>
                </div>
                <div class="sensor-row">
                    <span>Mixing:</span>
                    <span class="sensor-value" id="mixingStatus">OFF</span>
                </div>
                <div class="sensor-row">
                    <span>EC Target:</span>
                    <span class="sensor-value" id="currentECTarget">-- mS/cm</span>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card">
            <h3>üìà Data Chart</h3>
            <div class="chart-container">
                <canvas id="dataChart"></canvas>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="card">
            <h3>üîç Debug Log</h3>
            <div class="log" id="debugLog"></div>
        </div>
    </div>

    <script>
        let client = null;
        let isConnected = false;
        let chart = null;

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'EC Value',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0,123,255,0.1)',
                        tension: 0.4
                    }, {
                        label: 'pH Value',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40,167,69,0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left'
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Debug logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // Simple connection using different approach
        async function connect() {
            const brokerUrl = document.getElementById('brokerUrl').value;
            const clientId = document.getElementById('clientId').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            log('Attempting to connect...', 'info');
            updateStatus(false, 'Connecting...');

            try {
                // Try using the MQTT.js library instead of Paho
                if (typeof mqtt !== 'undefined') {
                    log('Using MQTT.js library', 'info');
                    
                    const options = {
                        clientId: clientId + '_web_' + Math.random().toString(36).substr(2, 9),
                        username: username,
                        password: password,
                        keepalive: 60,
                        protocolVersion: 4,
                        clean: true,
                        reconnectPeriod: 5000,
                        connectTimeout: 10000
                    };

                    client = mqtt.connect(brokerUrl, options);

                    client.on('connect', function() {
                        log('Connected successfully!', 'success');
                        isConnected = true;
                        updateStatus(true, 'Connected');
                        
                        // Subscribe to topics
                        const topics = [
                            `${clientId}/msg/data`,
                            `${clientId}/msg/status`
                        ];
                        
                        topics.forEach(topic => {
                            client.subscribe(topic);
                            log(`Subscribed to: ${topic}`, 'info');
                        });
                    });

                    client.on('message', function(topic, message) {
                        log(`Message from ${topic}: ${message.toString()}`, 'info');
                        handleMessage(topic, message.toString());
                    });

                    client.on('error', function(error) {
                        log(`Connection error: ${error.message}`, 'error');
                        updateStatus(false, 'Error: ' + error.message);
                    });

                    client.on('close', function() {
                        log('Connection closed', 'error');
                        isConnected = false;
                        updateStatus(false, 'Disconnected');
                    });

                } else {
                    // Fallback to native WebSocket
                    log('MQTT.js not available, trying WebSocket...', 'info');
                    connectWebSocket(brokerUrl, clientId, username, password);
                }

            } catch (error) {
                log(`Connection failed: ${error.message}`, 'error');
                updateStatus(false, 'Connection failed');
            }
        }

        // WebSocket fallback
        function connectWebSocket(url, clientId, username, password) {
            try {
                const wsUrl = url.replace('wss://', 'wss://').replace('ws://', 'ws://');
                log(`Trying WebSocket: ${wsUrl}`, 'info');
                
                const ws = new WebSocket(wsUrl, ['mqtt']);
                
                ws.onopen = function() {
                    log('WebSocket opened', 'success');
                    updateStatus(true, 'Connected (WebSocket)');
                    isConnected = true;
                };
                
                ws.onmessage = function(event) {
                    log(`WebSocket message: ${event.data}`, 'info');
                };
                
                ws.onerror = function(error) {
                    log(`WebSocket error: ${error}`, 'error');
                    updateStatus(false, 'WebSocket error');
                };
                
                ws.onclose = function() {
                    log('WebSocket closed', 'error');
                    isConnected = false;
                    updateStatus(false, 'Disconnected');
                };
                
            } catch (error) {
                log(`WebSocket failed: ${error.message}`, 'error');
                tryHttpPolling(clientId);
            }
        }

        // HTTP polling as last resort
        function tryHttpPolling(clientId) {
            log('Trying HTTP polling method...', 'info');
            updateStatus(false, 'Trying HTTP polling...');
            
            // Simulate connection for testing
            setTimeout(() => {
                log('HTTP polling not implemented - this is a demo', 'error');
                updateStatus(false, 'All methods failed');
            }, 2000);
        }

        function disconnect() {
            if (client && isConnected) {
                client.end();
                isConnected = false;
                updateStatus(false, 'Disconnected');
                log('Disconnected manually', 'info');
            }
        }

        function updateStatus(connected, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = message || 'Connected';
                text.style.color = '#28a745';
            } else {
                dot.classList.remove('connected');
                text.textContent = message || 'Disconnected';
                text.style.color = '#dc3545';
            }
        }

        function handleMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                
                if (topic.includes('/msg/data')) {
                    updateSensorData(data);
                } else if (topic.includes('/msg/status')) {
                    updateSystemStatus(data);
                }
                
                document.getElementById('lastUpdate').textContent = 
                    'Last Update: ' + new Date().toLocaleTimeString();
                    
            } catch (error) {
                log(`Failed to parse message: ${error.message}`, 'error');
            }
        }

        function updateSensorData(data) {
            document.getElementById('ecValue').textContent = (data.ec_value || 0).toFixed(2) + ' mS/cm';
            document.getElementById('phValue').textContent = (data.ph_value || 0).toFixed(2) + ' pH';
            document.getElementById('temperature').textContent = (data.temperature || 0).toFixed(1) + ' ¬∞C';
            document.getElementById('ecVoltage').textContent = (data.ec_voltage || 0).toFixed(2) + ' V';
            document.getElementById('phVoltage').textContent = (data.ph_voltage || 0).toFixed(2) + ' V';
            document.getElementById('adsStatus').textContent = data.ads_connected ? 'Connected' : 'Disconnected';
            document.getElementById('wifiRssi').textContent = (data.wifi_rssi || 0) + ' dBm';
            
            // Update chart
            if (chart) {
                const now = new Date().toLocaleTimeString();
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push(data.ec_value || 0);
                chart.data.datasets[1].data.push(data.ph_value || 0);
                
                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                }
                
                chart.update();
            }
        }

        function updateSystemStatus(data) {
            updatePumpIndicator('pumpA', data.pump_a);
            updatePumpIndicator('pumpB', data.pump_b);
            updatePumpIndicator('pumpMain', data.pump_main);
            
            document.getElementById('mixingStatus').textContent = data.mixing ? 'ON' : 'OFF';
            document.getElementById('currentECTarget').textContent = (data.ec_target || 0).toFixed(1) + ' mS/cm';
            
            const mixingBtn = document.getElementById('mixingBtn');
            mixingBtn.textContent = data.mixing ? 'Stop Mixing' : 'Start Mixing';
            mixingBtn.onclick = data.mixing ? 
                () => sendCommand('stop_mixing') : 
                () => sendCommand('start_mixing');
        }

        function updatePumpIndicator(pumpId, isActive) {
            const indicator = document.getElementById(pumpId);
            if (isActive) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        function sendCommand(command, value = null) {
            if (!client || !isConnected) {
                log('Not connected - cannot send command', 'error');
                return;
            }

            const clientId = document.getElementById('clientId').value;
            const topic = `${clientId}/msg/control`;
            
            const message = { command: command };
            if (value !== null) {
                message.value = value;
            }

            const messageStr = JSON.stringify(message);
            
            try {
                client.publish(topic, messageStr);
                log(`Sent command: ${messageStr}`, 'success');
            } catch (error) {
                log(`Failed to send command: ${error.message}`, 'error');
            }
        }

        function setECTarget() {
            const value = parseFloat(document.getElementById('ecTarget').value);
            if (!isNaN(value)) {
                sendCommand('set_ec', value);
            }
        }

        function setVolume() {
            const value = parseInt(document.getElementById('volumeTarget').value);
            if (!isNaN(value)) {
                sendCommand('set_volume', value);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Dashboard initialized', 'info');
            initChart();
            
            // Auto-connect after 2 seconds
            setTimeout(() => {
                log('Auto-connecting...', 'info');
                connect();
            }, 2000);
        });
    </script>
</body>
</html>
